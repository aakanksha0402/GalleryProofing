
<% content_for :body_class, "new-invoice-index"%>
<%#= render 'form' %>
<%= nested_form_for @invoice,url: invoices_path,method: :post do |f| %>
  <% if @invoice.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@invoice.errors.count, "error") %> prohibited this invoice from being saved:</h2>

      <ul>
      <% @invoice.errors.full_messages.each do |message| %>
        <li><%= message %></li>
      <% end %>
      </ul>
    </div>
  <% end %>
<!-- top -->
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-12">
      <!-- title -->
      <div class="page-title">
        <div class="row">
          <div class="col-md-6 col-sm-5 col-xs-5">
            <h2>
                <div id="pageTitleHeaderText">New Invoice</div>
            </h2>
          </div>

          <div class="col-md-6 col-sm-7 col-xs-7">
            <div class="right-buttons text-right">
              <a class="btn btn-default" disabled href="#" data-toggle="modal" data-target="#newauto-filter" >Client View</a>
              <a class="btn btn-default" disabled href="#" data-toggle="modal" data-target="#newauto-filter" >Send Email</a>
              <!-- <a class="btn btn-primary" href="#" data-toggle="modal" data-target="#new-invoice" >Save</a> -->
              <%= f.submit "Save",class: "btn btn-primary"%>

            </div>
            <div class="save-new-template">
                <div class="checkbox">
                  <% if params[:template_id].present? %>
                    <%= f.check_box :is_template,checked: false %>
                  <% else %>
                    <%= f.check_box :is_template %>
                  <% end %>
                  <label>Save New Template?</label>
                </div>
              </div>

          </div>
        </div>
      </div>
      <!-- /title -->
    </div>
  </div>
</div>
<!-- /top -->

<!-- main -->
<div class="container-fluid">
      <div class="row">
          <div class="col-lg-3" id="contact_name_search">
            <div class="client-contact">
              <div class="form-group">
                <h5>Contact</h5>
                  <label>Name</label>
                  <%= text_field_tag 'contact_name','',class: "form-control" %>
                  <div class="dropdown-menu" id="auto_fill"></div>
              </div>
            </div>
          </div>
          <div class="col-lg-3 edit-invoice-none" style="display:none">
            <div class="client-contact">
              <div class="form-group">
                <h5>Contact</h5>
                <%= hidden_field_tag "contact_id" %>
               <div class="address-display"><p>XYZ ABC<br>xyz@gmail.com<br>00000000000<br>Qwerty<br>Qwerty<br>000 000<br>BH</p></div>
               <a class="show-addres" href="#">Edit Address</a>
              </div>
            </div>
          </div>
          <div class="col-lg-6" style="display:none" id="new_contact">
            <h5>Contact</h5>
            <div style="display: block;" class="alert alert-info new-contact-created-on-save">
                <p>When you save this Invoice, a new Contact will be added.</p>
            </div>
            <div class="row">
                <div class="col-lg-3">
                   <div class="form-group">
                     <label>First Name</label>
                      <%= text_field_tag 'first_name','',class: "form-control" %>
                       <!-- <input type="text" class="form-control"></input> -->
                   </div>
                </div>
                <div class="col-lg-3">
                   <div class="form-group">
                     <label>Last Name</label>
                      <%= text_field_tag 'last_name','',class: "form-control" %>
                       <!-- <input type="text" class="form-control"></input> -->
                   </div>
                </div>
                <div class="col-lg-3">
                   <div class="form-group" id="email_div">
                     <label>Email</label>
                      <%= text_field_tag 'email','',class: "form-control"%>
                       <!-- <input type="text" class="form-control"></input> -->
                   </div>
                </div>

                <div class="col-lg-3">
                   <div class="form-group">
                     <label>Phone</label>
                      <%= text_field_tag 'phone_number','',class: "form-control"%>
                       <!-- <input type="text" class="form-control"></input> -->
                   </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-12">
                  <div class="form-group">
                     <label>Address</label>
                      <%= text_field_tag 'address1','',class: "form-control",placeholder: "Street Address Line 1" %>
                       <!-- <input type="text" class="form-control" placeholder="Street Address Line 1"></input> -->
                   </div>
                   <div class="form-group">
                      <%= text_field_tag 'address2','',class: "form-control",placeholder: "Street Address Line 2 (optional)" %>
                       <!-- <input type="text" class="form-control" placeholder="Street Address Line 2 (optional)"></input> -->
                   </div>
                   <div class="form-group">
                      <%= collection_select(:client_contact,:country_id,Country.all,:id,:name,{selected: @country},{class: "selectpicker brands-set",'data-live-search': true}) %>

                   </div>
                </div>
              </div>
              <div class="row">
                <div class="col-lg-4">
                  <div class="form-group">
                    <%= text_field_tag 'city','',class: "form-control",placeholder: "City" %>
                    <!-- <input type="text" class="form-control" placeholder="City"></input> -->
                  </div>
                </div>
                <% if @state_province.present?  %>
                  <div class="col-lg-4">
                    <div class="form-group" id="state_and_province">
                      <%= collection_select(:client_contact,:state_province_id,@state_province.all,:id,:name,{},{class: "selectpicker brands-set",'data-live-search': true}) %>
                    </div>
                  </div>
                <% else %>
                  <div class="col-lg-4">
                    <div class="form-group">
                    </div>
                  </div>
                <% end %>
                <div class="col-lg-4">
                  <div class="form-group">
                      <%= text_field_tag 'pincode','',class: "form-control",placeholder: "Postal Code"%>
                     <!-- <input type="text" class="form-control" placeholder="Postal Code"></input> -->
                  </div>
                </div>
                <div class="col-lg-12">
                  <%= check_box_tag "update_contact_address",true,true %>&nbsp;&nbsp;Update Contact address?
                </div>
              </div>
          </div>
          <div class="col-lg-3">
            <h5>From</h5>
            <div class="brand-name"><%= current_brand.brand_name%></div>
            <div class="brand-address"><%= current_brand.address1 %><br/><%= current_brand.address2%> <br><%= current_brand.city %> <%= current_brand.pincode%></div>
            <div class="lightbox">
              <div class="hover-alert" style="display:none">
                You have turned watermarks <strong>on</strong> by default for all techbit<br/> galleries.
              </div>
            </div>
          </div>
      </div>
      <div class="row">
        <div class="col-lg-12">
          <div class="main-form-group">
            <div class="form-group ">
              <label>Automated Emails</label>
                <%= f.collection_select(:automation_series_id, current_brand.automation_series.all, :id, :name, {include_blank: "Select one"}, class: "selectpicker brands-set") %>
            </div>

            <div class="form-group ">
              <label>Language</label>
                <select class="selectpicker brands-set" data-live-search="true"> <!-- form-control input-lg -->
                 <option>Danish</option>
                 <option>Dutch</option>
                 <option>English (UK)</option>
                 <option>English (US)</option>
                 <option>German</option>
                 <option>Italian</option>
                 <option>Norwegian</option>
                 <option>Polish</option>
                 <option>Portuguese (Brazil)</option>
                 <option>Portuguese (Portugal)</option>
                 <option>Slovenian</option>
                 <option>Spanish</option>
                 <option>Swedish</option>
               </select>
            </div>

            <div class="form-group ">
              <label>Invoice Theme</label>
              <%= f.collection_select(:color_logo_id, current_brand.color_logos.all, :id, :name, {include_blank: "Select one"}, class: "selectpicker brands-set") %>
            </div>

            <div class="form-group">
              <label>Issued Date</label>
              <!-- <input type="text" class="form-control"></input> -->
             <div class="input-append date ">
                 <div id="datetimepicker-in-2">
                   <%= f.text_field :issue_date,value: "#{Date.today.to_s}",'data-format': "yyyy-MM-dd" %>
                    <!-- <input type="text" data-format="dd/MM/yyyy"> -->
                    <span class="add-on">
                      <span class="celender"><i aria-hidden="true" class="fa fa-calendar icon-calendar"></i></span>
                    </span>
                  </div>
              </div>
            </div>

            <div class="form-group">
              <label>Final Due Date</label>
              <!-- <input type="text" class="form-control"></input> -->
              <ul class="form-error list-unstyled" style="display:none" id= "due_date_create"><li>Final payment due date must be on or after the issued date.</li></ul>
              <div class="input-append date ">
                 <div id="datetimepicker-in-1">
                   <%= f.text_field :final_due_date,'data-format': "yyyy-MM-dd" %>
                    <!-- <input type="text" data-format="dd/MM/yyyy"> -->
                    <span class="add-on">
                      <span class="celender"><i aria-hidden="true" class="fa fa-calendar icon-calendar"></i></span>
                    </span>
                  </div>
              </div>
            </div>

          </div>
        </div>
      </div>

        <div class="row">
          <div class="col-lg-12 table-view-tag">
          <div class="row">
             <div class="col-lg-1 empty-shell"><span class="heading-table"></span></div>
             <div class="col-lg-1 sec-empty-shell"><span class="heading-table">#</span></div>
             <div class="col-lg-3"><span class="heading-table">Name</span></div>
             <div class="col-lg-3"><span class="heading-table">Description</span></div>
             <div class="col-lg-1"><span class="heading-table">Quantity</span></div>
             <div class="col-lg-2 third-empty-shell"><span class="heading-table">Item Price</span></div>
             <div class="col-lg-1 total-empty-shell"><span class="heading-table">Total Price</span></div>
             <div class="col-lg-1 four-empty-shell"><span class="heading-table">Taxable</span></div>
             <div class="col-lg-1 clear-empty-shell"><span class="heading-table"></span></div>
             <div class="col-lg-1 link-empty-shell"><span class="heading-table"></span></div>
          </div>
              <%= f.fields_for :invoice_line_items do |ff| %>
              <div class="row table-tag-view " style="background: #F0F4F5;padding-top: 15px;">
                <input type="hidden" class="invoice-item-id">
                <%= hidden_field_tag "invoice_item_template_id",'',class: "invoice-item-template-id" %>
                <%= ff.hidden_field :display_order,class: "invoice-item-display-order" %>
               <div class="col-lg-1 empty-shell"><span class="table-view"></span></div>
               <div class="col-lg-1 sec-empty-shell"><span class="table-view">1</span></div>
               <div class="col-lg-3">
                <span class="table-view">
                  <div class="form-group">
                    <%= ff.text_field :name, class: "form-control  typeahead name prevent-enter tt-input", placeholder: "Name",style: "position: relative; vertical-align: top; background-color: transparent;" %>
                  </div>
                </span>
                </div>
               <div class="col-lg-3">
                <span class="table-view">
                  <div class="form-group">
                    <%= ff.text_area :description, class: "form-control", placeholder: "Description" %>
                  </div>
                </span>
              </div>
               <div class="col-lg-1">
                <span class="table-view">
                  <div class="form-group">
                    <%= ff.text_field :quantity, class: "form-control", placeholder: "Qty" %>
                  </div>
                </span>
              </div>
               <div class="col-lg-2 third-empty-shell">
                <span class="table-view">
                  <div class="input-group">
                    <div class="input-group-addon">$</div>
                    <%= ff.text_field :price,class: "form-control", placeholder: "Item Price"%>
                  </div>
                </span>
              </div>
               <div class="col-lg-1 total-empty-shell">
                <span class="table-view price-set">
                  <label class="price-display"></label>
                  <%= ff.hidden_field :total_price,class: "form-control price money-only" %>
                </span>
              </div>
                <div class="col-lg-1 four-empty-shell">
                <span class="table-view price-set">
                 <div class="checkbox">
                   <%= ff.hidden_field :tax %>
                   <%= ff.check_box :is_taxable %>
                  <label class="optional" for="remember"></label>
                </div>
                </span>
              </div>
            <div class="col-lg-1 clear-empty-shell">
              <span class="table-view  price-set">
              <div class="remove-item js-remove-invoice-item">
                <%= ff.link_to_remove "&times;".html_safe %>
              </div>
            </span>
            </div>
            <div class="col-lg-1 link-empty-shell" >
              <span class="heading-table">
                <%= link_to "Save to Use Again" , "#", class: "js-save-as-invoice-item-template",onclick: "SaveLineItem(this)", style: "display:none" %>
              </span>
            </div>
          </div>
          <% end %>
        </div>
        </div>
      <div class="row">
        <div class="col-lg-12">
          <%= f.link_to_add "Add Item", :invoice_line_items, class: "btn btn-default" %>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-8">
          <div class="row">
            <div class="col-lg-6">
              <h5>Sales Tax</h5>
              <div class="form-group pull-left sector-second">
                <label>Label</label>
                <%= f.text_field :sales_label,class: "form-control"%>
                <!-- <input type="text" class="form-control"></input> -->
              </div>
              <div class="form-group pull-left">
                  <label>Rate</label>
                  <div class="input-group sales-tax-percent-container">
                    <%= f.text_field :sales_rate,class: "form-control" %>
                      <!-- <input type="text" id="sales_tax_percent"  class="form-control"> -->
                      <div class="input-group-addon">%</div>
                  </div>
              </div>
            </div>

            <div class="col-lg-6">
              <h5>Deposit</h5>
              <div class="form-group invoice-dropdown">
                <label>Type</label>
                <%= f.collection_select(:deposit_type_id, DepositType.all, :id, :deposit_type, {include_blank: "None"}, class: "selectpicker brands-set") %>
              </div>
              <div class="form-group" id="deposit_amount"  style="display:none">
                <label>Amount</label >
                <div class="input-group Item-Price second-timer pull-left">
                  <div class="input-group-addon" id="fixed_amt">$</div>
                  <%= f.text_field :deposit_amount,class: "form-control" %>
                  <div class="input-group-addon" id="percent">%</div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-6">
              <div Class="form-group text-type-side">
                <h5>Notes to Client</h5>
                <%= f.text_area :notes_to_client,class: "form-control" %>
                <!-- <textarea class="form-control"></textarea> -->
              </div>
            </div>
            <div class="col-lg-6">
              <h5>Payment Options</h5>
              <div class="checkbox inside-check">
                <%= f.check_box :allow_payment_cash_cheque %>
                <label>Cash/Check</label>
              </div>
              <div class="checkbox inside-check">
                <%= f.check_box :allow_payment_credit_card %>
                <label>Credit Card</label>
              </div>
              <p>Your studio is not setup to accept credit card payments.<a href="#">Setup credit card payments</a> to enable this option.</p>
              <div class="form-group">
                <h5>Payment Confirmation Text</h5>
                <%= f.text_area :payment_confirmation_text,class: "form-control" %>
                <!-- <textarea class="form-control"></textarea> -->
              </div>
            </div>
          </div>
        </div>

        <div class="col-sm-4">
          <div class="row">
            <div class="col-lg-12">
                <table id="totalsTable" class="text-right pull-right">
                    <tbody>
                      <tr>
                        <td class="value-name top-row">Subtotal</td>
                        <td class="value-amount top-row">
                          $<span class="subtotal">0.00</span>
                        </td>
                      </tr>
                      <tr>
                        <td class="value-name">Sales Tax<span class="sales-tax-percent-display" style="display: none;"></span></td>
                        <td class="value-amount">
                          $<span class="sales-tax-amount">0.00</span>
                        </td>
                      </tr>
                      <tr>
                        <td class="value-name bold">Grand Total</td>
                        <td class="value-amount bold">
                         $<span class="grand-total">0.00</span>
                        </td>
                      </tr>
                      <tr>
                        <td class="value-name">Deposit</td>
                        <td class="value-amount">
                            $<span class="deposit-total">0.00</span>
                        </td>
                      </tr>
                      <tr>
                          <td class="value-name bottom-row bold">Total Paid</td>
                          <td class="value-amount bottom-row bold">
                            -$<span class="total-paid">0.00</span>
                          </td>
                      </tr>
                      <tr>
                            <td class="value-name balance-due-cell bold">Balance Due</td>
                            <td class="value-amount balance-due-cell bold">
                            $<span class="balance-due">0.00</span>
                            </td>
                      </tr>
                    </tbody>
                </table>
            </div>
          </div>
        </div>
      </div>

       <div class="row" style="display:none">
          <div class="col-lg-6">
            <h2>Payments</h2>
              <table class="table table-striped table-responsive">
                    <thead>
                        <tr>
                          <th>Date Received</th>
                          <th>Payment Date</th>
                          <th>Amount</th>
                          <th>Type</th>
                          <th>Memo</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td>02-Jul-2016 10:59:26 am IST</td>
                          <td>30-Jun-2016</td>
                          <td>$&nbsp;50.00</td>
                          <td>Cash / Check</td>
                          <td></td>
                        </tr>
                      </tbody>
              </table>
          </div>
        </div>
    </div>
<!-- /main -->

<!-- Modal -->
<div class="modal" id="delete-tab" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Delete Line Item Template?</h4>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete line item "New Item"?</p>
        <p>The invoice line item template will no longer be accessible.<strong>This action cannot be undone!</strong></p>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-sm btn-danger">Yes, Delete</button>
      </div>
    </div>
  </div>
</div>
<!-- /mMdal -->


<!-- Modal -->
<div id="template_name" class="modal description-modal" role="dialog" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 class="modal-title">Create new invoice template after save?</h4>
      </div>
      <div class="modal-body">
        <p>To save this invoice as a template for future use, you must provide a name for the template.</p>

        <p>Once your changes to the invoice have been saved, the template will be created from it.</p>
        <div class="form-group">
          <label>Template Name</label>
          <%= f.text_field :template_name, class: "form-control", maxlength: 100, size: 30 %>
          <!-- <input name="invoice_template_name" id="invoice_template_name" class="form-control" maxlength="100" size="30" type="text"> -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <%= f.submit "Save and Create Template",class: "btn btn-primary" %>
      </div>
    </div>

  </div>
</div>


<% end %>


<script type="text/javascript">
  $(document).ready(function(){
    $(".checkbox input").click(function(){
      if($(this).is(':checked')){
        $(this).parent('.checkbox').addClass('checked-box');
      }
      else{
       $(this).parent('.checkbox').removeClass('checked-box');
      }
    })
  });

</script>

<script type="text/javascript">
  $('.sitemenu > li').mouseout(function() {
  $(this).children('.dropdown-menu').hide();
  });
  $('.sitemenu > li').mouseover(function() {
  $(this).children('.dropdown-menu').show();
  });
</script>

<script type="text/javascript">
  $(document).ready(function($) {
      $(".clickable-row>td").click(function() {
        if($(this).hasClass('deleted')){
        }
        else{
          window.document.location = $(this).parent().data("href");
        }
      });
  });
</script>
<script type="text/javascript">
  $(function() {
    $('#datetimepicker-in-1').datetimepicker({
    language: 'pt-BR'
    });
    $('#datetimepicker-in-1').on('changeDate', function(ev){
        $('#datetimepicker-in-1').datetimepicker('hide');
    });
  });
</script>

<script type="text/javascript">
  $(function() {
    $('#datetimepicker-in-2').datetimepicker({
    language: 'pt-BR'
    });
    $('#datetimepicker-in-2').on('changeDate', function(ev){
        $('#datetimepicker-in-2').datetimepicker('hide');
    });
  });
</script>
<script>
  $(function() {
    $( "#sortable" ).sortable();
    $( "#sortable" ).disableSelection();
  });
</script>
<script>
  $("#contact_name").keyup(function(){
    var user_id = "<%=j params[:id]%>";
    var name = $(this).val();
    $.ajax({
      type: "get",
      url: "/invoices/contact_suggestions",
      data: {id: user_id,name: name}
    }).success();
  });
  $("#contact_name").on('focusout',function(){
    var user_id = "<%=j params[:id]%>";
    var name = $(this).val();
    $.ajax({
      type: "get",
      url: "/invoices/contact_suggestions",
      data: {id: user_id,name: name}
    }).success();
  });

  $('input[id$="_name"]').keyup(function(){
    var name = $(this).val();
    $.ajax({
      type: 'get',
      url: '/invoices/line_item_suggestion',
      data: {name: name}
    }).success();
  });
</script>
<script>
  $("#contact_id").on('change',function(){
    if($(this).val() != ""){
      $("#contact_name_search").hide();
      $(".edit-invoice-none").show();
    }
  });
</script>
<script>
  $('input[type="submit"]').click(function(event){
    if($(this).val() == "Save" && $("#invoice_is_template").prop('checked') == true ){
      event.preventDefault();
      $("#template_name").modal('show');
    }
    var name_flag = 0;
    $('.fields input[id$="_name"]').each(function(){
      if($(this).val()==""){
        name_flag = 1;
      }
    });

    var flag = 0;
    $('input[id$="_is_taxable"]').each(function(){
      if ($(this).prop('checked') == true){
        flag = 1;
      }
    });


    $(".new-invoice-index").find(".has_error").removeClass("has_error");
    if($(".grand-total").text() == (0.00).toFixed(2)){
      hoveralert("Your invoice has a grand total of $0.00. Please review and try again.");
      event.preventDefault();
    }else if($("#invoice_final_due_date").val() == ""){
      hoveralert("Please choose a final payment due date.");
      $("#invoice_final_due_date").addClass('has_error');
      $("#invoice_final_due_date").parent().find(".icon-calendar").addClass('has_error');
      event.preventDefault();
    }else if ($("#invoice_allow_payment_cash_cheque").prop('checked') == false && $("#invoice_allow_payment_credit_card").prop('checked') == false) {
      hoveralert("Please choose a payment method.");
      event.preventDefault();
    }else if ($("#contact_name").val() == "" && $("#contact_id").val() == "" ){
      $("#contact_name").addClass('has_error');
      $("#first_name").addClass('has_error');
      $("#email").addClass('has_error');
      hoveralert("You have not chosen a Contact, or entered information for a new Contact.");
      console.log("1234");
      event.preventDefault();
    }else if ($("#contact_name_search").css("display") == "none"   &&   $("#contact_id").val() == "") {
      if($("#first_name").val() == "" && $("#email").val() == ""){
        $("#first_name").addClass('has_error');
        $("#email").addClass('has_error');
        console.log("both");
        hoveralert("You have not chosen a Contact, or entered information for a new Contact.");
        event.preventDefault();
      }else if($("#first_name").val() == "" ){
        $("#first_name").addClass('has_error');
        hoveralert("You have not chosen a Contact, or entered information for a new Contact.");
        console.log("first_name");
        event.preventDefault();
      }else if($("#email").val() == ""){
        $("#email").addClass('has_error');
        hoveralert("You have not chosen a Contact, or entered information for a new Contact.");
        console.log("email");
        event.preventDefault();
      }
    }else if (name_flag == 1){
      $('input[id$="_name"]').each(function(){
        if($(this).val()==""){
          $(this).addClass('has_error');
        }
      });
      hoveralert("One or more of your items has errors. Please review and try again.");
      event.preventDefault();
    }else if(flag == 1){
      console.log(flag);
      if($("#invoice_sales_label").val() == ""  &&  $("#invoice_sales_rate").val() == ""){
        $("#invoice_sales_label").addClass('has_error');
        $("#invoice_sales_rate").addClass('has_error');
        $("#invoice_sales_rate").parent().find(".input-group-addon").addClass('has_error');
        hoveralert("You have taxable items on this invoice. Please set a sales tax label and percentage.");
        event.preventDefault();
      }else if($("#invoice_sales_label").val() == ""){
        $("#sales_label").addClass('has_error');
        hoveralert("You have taxable items on this invoice. Please set a sales tax label and percentage.");
        event.preventDefault();
      }else if($("#invoice_sales_rate").val() == ""){
          $("#invoice_sales_rate").addClass('has_error');
          $("#invoice_sales_rate").parent().find(".input-group-addon").addClass('has_error');
          hoveralert("You have taxable items on this invoice. Please set a sales tax label and percentage.");
          event.preventDefault();
      }
    }
  });

  function hoveralert(alert_text) {
    console.log(alert_text);
    $(".hover-alert").text(alert_text);
    $(".hover-alert").fadeIn('slow').delay(1000);
    $(".hover-alert").fadeOut('slow').delay(1000);
  }
</script>
<script>
  $("#invoice_sales_rate").on('focusout',function(){
    $(this).removeClass('has_error');
    $(this).parent().find(".input-group-addon").removeClass('has_error');
    if ($(this).val() > 100){
      console.log(($(this).val()));
    }
    if($(this).val() > 100 || isNaN($(this).val()) == true){
      console.log(($(this).val()));
      if(isNaN($(this).val()) == true){
        $("#invoice_sales_rate").val(0.000);
      }
      $(this).addClass('has_error');
      $(this).parent().find(".input-group-addon").addClass('has_error');
      $(".hover-alert").text("Please enter a valid sales tax percentage.");
      $(".hover-alert").fadeIn('slow').delay(1000);
      $(".hover-alert").fadeOut('slow').delay(1000);
      event.preventDefault();
    }
  });
</script>
<script>
  $("#invoice_deposit_type_id").change(function(){
    if($(this).val() == 1){
      $("#deposit_amount").show();
      $("#fixed_amt").hide();
      $("#percent").show();
    }else if ($(this).val() == 2) {
      $("#deposit_amount").show();
      $("#fixed_amt").show();
      $("#percent").hide();
    }else{
      $("#deposit_amount").hide();
    }
  });
</script>
<script>
  $('input[id$="_quantity"]').on('focusout',function(){
    var price = $(this).parent().parent().find('td input[id^="_price"]').val();
  });
</script>
<script>
  $("#client_contact_country_id").change(function(){
    $.ajax({
      type: 'get',
      url: '/invoices/state_list',
      data: {country_id: $(this).val()}
    }).success();
  });
</script>
<script>
  // window.nestedFormEvents.insertFields = function(content, assoc, link) {
  //   alert(jQuery.type(content));
  //   console.log(content);
  //   alert($(content).find(".sec-empty-shell").text());
  //   $(content).find(".sec-empty-shell").text(parseInt($(content).find(".sec-empty-shell").text())+1);
  //   $(".table-view-tag").append($(content));
  // }
</script>
<script>

  $(document).on('nested:fieldAdded', function(event){
    var field = event.field;
    var qtyField = field.find('input[id$="_quantity"]');
    var priceField = field.find('input[id$="_price"]');
    var priceDisplayField = field.find(".price-display");
    var priceValueField = field.find('input[id$="_total_price"]');
    var tax = field.find('input[id$="_tax"]');

    var sum = 0;
    qtyField.focusout(function(){
      console.log("qtyField");
      priceDisplayField.text((qtyField.val() * priceField.val()).toFixed(2));
      priceValueField.val(qtyField.val() * priceField.val());
      summation();
      tax.val(priceValueField.val() * $("#invoice_sales_rate").val()/100);
      tax_summation();
      grand_total();
      tax_changed();
    });
    priceField.focusout(function(){
      console.log("priceField");
      priceDisplayField.text((qtyField.val() * priceField.val()).toFixed(2));
      priceValueField.val(qtyField.val() * priceField.val());
      summation();
      tax.val(priceValueField.val() * $("#invoice_sales_rate").val()/100);
      tax_summation();
      grand_total();
      tax_changed();
    });
    fieldsCount = $('form .fields').length;
    console.log(fieldsCount);
    var displayOrderField = field.find('input[id$="_display_order"]');
    var display = field.find(".sec-empty-shell");
    display.text((fieldsCount));
    displayOrderField.val(fieldsCount);

    var checkbox = field.find(".checkbox input");
    checkbox.click(function(){
      if($(this).is(':checked')){
        $(this).parent('.checkbox').addClass('checked-box');
        tax.val(priceValueField.val() * $("#invoice_sales_rate").val()/100);
      }
      else{
       $(this).parent('.checkbox').removeClass('checked-box');
      }
      if(checkbox.parent().hasClass('checked-box')){
        tax_summation();
        grand_total();
        tax_changed();
      }else{
        tax_summation();
        grand_total();
        tax_changed();
      }
    });
    var name = field.find('input[id$="_name"]');
    name.each(function(){
      $(this).keyup(function(){
        if($(this).val().length == 0){
          $(this).parent().parent().parent().parent().find(".link-empty-shell").find(".js-save-as-invoice-item-template").css("display","none");
        }else{
          $(this).parent().parent().parent().parent().find(".link-empty-shell").find(".js-save-as-invoice-item-template").css("display","block");;
        }
      });
    });

  });

  function summation(){
    var sum = 0;
    $('form .fields').find('input[id$="_total_price"]').each(function(){
      sum = sum + parseInt($(this).val());
    });
    $(".subtotal").text((sum).toFixed(2));
    // console.log("**********"+sum);
  }
  function tax_summation(){
    var tax_sum = 0;
    $('form .fields').find('input[id$="_tax"]').each(function(){
      if($(this).parent().find('input[id$="_is_taxable"]').prop('checked') == true){
        tax_sum = tax_sum + parseInt($(this).val());
      }
    });
    $(".sales-tax-amount").text((tax_sum).toFixed(2));
  }
  function grand_total(){
    $(".grand-total").text((parseInt($(".sales-tax-amount").text()) + parseInt($(".subtotal").text())).toFixed(2));
  }
  function tax_changed(){
    if($("#invoice_deposit_type_id").val() == "1"){
      if ($("#invoice_deposit_amount").val() > 100){
        $(("#invoice_deposit_amount")).addClass('has_error');
        $(("#invoice_deposit_amount")).parent().find("#percent").addClass('has_error');
        hoveralert("Deposit amount cannot be greater than the grand total.");
      }else if ($("#invoice_deposit_amount").val() < 0) {
        $(("#invoice_deposit_amount")).addClass('has_error');
        $(("#invoice_deposit_amount")).parent().find("#percent").addClass('has_error');
        hoveralert("Deposit amount cannot be greater than the grand total.");
      }else if($("#invoice_deposit_amount").val() < 0.1){
        $("#invoice_deposit_amount").val(0.1);
        $(".deposit-total").text(($(".grand-total").text() * $("#invoice_deposit_amount").val()/100).toFixed(2));
      }else{
        $(".deposit-total").text(($(".grand-total").text() * $("#invoice_deposit_amount").val()/100).toFixed(2));
      }
    }else if ($("#invoice_deposit_type_id").val() == "2"){
      if($(("#invoice_deposit_amount")).val() > parseInt($(".grand-total").text())){
        $(("#invoice_deposit_amount")).addClass('has_error');
        $(("#invoice_deposit_amount")).parent().find("#fixed_amt").addClass('has_error');
        hoveralert("Deposit amount cannot be greater than the grand total.");
      }else if ($(("#invoice_deposit_amount")).val() < 0) {
        $(("#invoice_deposit_amount")).addClass('has_error');
        $(("#invoice_deposit_amount")).parent().find("#fixed_amt").addClass('has_error');
        hoveralert("Deposit amount cannot be less than 0.");
      }else{
        $(".deposit-total").text(($(("#invoice_deposit_amount")).val()).toFixed(2));
      }
    }else{
    }
  }
  function due_amount(){
    $(".balance-due").text((parseInt($(".total-paid").text()) - parseInt($(".grand-total").text())).toFixed(2));
  }

</script>
<!-- Script for initial nested fields -->
<script>
  $(document).ready(function(){
    $('input[id$="_quantity"]').on('focusout',function(){
      var v
      if (isNaN($(this).val())){
        v = "";
        $(this).val("");
      }else{
        v= $(this).val()
      }
      $(this).parent().parent().parent().parent().find('input[id$="_total_price"]').val($('input[id$="_price"]').val() * v);
      $(this).parent().parent().parent().parent().find(".price-display").text($('input[id$="_total_price"]').val());
      // $(".sales-tax-amount").text(parseInt($(".sales-tax-amount").text())+$('input[id$="_tax"]').val($('input[id$="_total_price"]').val() * $("#invoice_sales_rate").val()/100))
      $(this).parent().parent().parent().parent().parent().find('input[id$="_tax"]').val($('input[id$="_total_price"]').val() * $("#invoice_sales_rate").val()/100);
      tax_summation();
      summation();
      grand_total();
      tax_changed();
      due_amount();
    });
    $('input[id$="_price"]').on('focusout',function(){
      var v
      if (isNaN($(this).val())){
        v = "";
        $(this).val("");
      }else{
        v= $(this).val()
      }
      $(this).parent().parent().parent().parent().find('input[id$="_total_price"]').val($('input[id$="_quantity"]').val() * v);
      $(this).parent().parent().parent().parent().find(".price-display").text($('input[id$="_total_price"]').val());
      summation();
      $(this).parent().parent().parent().parent().parent().find('input[id$="_tax"]').val($('input[id$="_total_price"]').val() * $("#invoice_sales_rate").val()/100);
      tax_summation();
      grand_total();
      tax_changed();
      due_amount();
    });
    $('input[id$="_display_order"]').each(function(){
      $(this).val($(this).parent().find(".sec-empty-shell").text());
    });
    $("#tax").val($('input[id$="_total_price"]').val() * $("#invoice_sales_rate").val()/100);
    $("#invoice_sales_rate").on('focusout',function(){
      $("form .fields").find('input[id$="_tax"]').each(function(){
        $(this).val($(this).parent().parent().parent().parent().find('input[id$="_total_price"]').val() * $("#invoice_sales_rate").val()/100);
      });
      tax_summation();
      grand_total();
      tax_changed();
      due_amount();
    });
    $('input[id$="_is_taxable"]').click(function(){
      if($(this).parent().hasClass('checked-box')){
        tax_summation();
        grand_total();
        tax_changed();
        due_amount();
      }else{
        tax_summation();
        grand_total();
        tax_changed();
        due_amount();
      }
    });
  });
</script>
<script>
  $(document).ready(function(){
    $("#invoice_deposit_amount").on('focusout',function(){
      $(".new-invoice-index").find(".has_error").removeClass("has_error");
      tax_changed();
      due_amount();
    });
  });
</script>
<script>
  $('input[id$="_name"]:not("#contact_name, #first_name, #last_name, #invoice_template_name")').each(function(){
    $(this).keyup(function(){
      if($(this).val().length == 0){
        $(this).parent().parent().parent().parent().find(".link-empty-shell").find(".js-save-as-invoice-item-template").css("display","none");
      }else{
        $(this).parent().parent().parent().parent().find(".link-empty-shell").find(".js-save-as-invoice-item-template").css("display","block");;
      }
    });
  });
</script>
<script>
  function SaveLineItem(id){
    console.log(id);
    var field = $(".fields").find(id);
    var  name = field.parent().parent().parent().find('input[id$="_name"]').val();
    var description = field.parent().parent().parent().find('.description-container').find('textarea').val();
    var quantity = field.parent().parent().parent().find('input[id$="_quantity"]').val();
    var price = field.parent().parent().parent().find('input[id$="price"]').val();
    var total_price = field.parent().parent().parent().find('input[id$="_total_price"]').val();
    if (field.parent().parent().parent().find('input[id$="_is_taxable"]').parent().hasClass('checked-box')){
      var is_taxable = true;
    }else{
      var is_taxable = false;
    }
    $.ajax({
      type: "get",
      url: "/invoice_line_items/save_invoice_line_item",
      data: {name: name, description: description, quantity: quantity, price: price,is_taxable: is_taxable,total_price: total_price}
    }).success();
  }
</script>
<script>
$('input[type="submit"]').click(function(event)
{
  if ($('#invoice_issue_date').val() > $('#invoice_final_due_date').val())
  {
       $('#due_date_create').css("display","block");
       event.preventDefault();
  }
});
</script>
<script>
$('input[type="submit"]').click(function(event)
{
  var email_regex =  new RegExp(/^[+a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/i);
  if( email_regex.test($('#email').val()) == false )
  {
      if($('#e_div').length)
      {

      }
      else
      {
        $('#email_div').append('<p style="color:red;" id="e_div" >Please enter valid email address.<p>');
        $('#email').css('border-color', 'red');
      }

    event.preventDefault(event);
  }
})
</script>
